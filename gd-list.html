<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/core-ajax/core-ajax.html">
<link rel="import" href="bower_components/core-list/core-list.html">

<link rel="import" href="gd-show.html">

<polymer-element name="gd-list" attributes="">
    <template>
        <style>
            core-list {
                height: 100%;
            }
            gd-show {
                height: 200px;
            }
        </style>
        
        <core-ajax id="ajax"
                   url="https://archive.org/advancedsearch.php"
                   params="{{params}}"
                   handleAs="json"
                   response="{{shows}}">
        </core-ajax>
        
        <core-list id="list" data="{{shows.response.docs}}">
            <template>
                <gd-show identifier="{{model.identifier}}" albumart="{{getAlbumArt()}}" 
                         on-show-click="{{showClickResponse}}">
                    <div class="band">{{extractBand(model.title)}}</div>
                    <div class="date">{{extractDate(model.date)}}</div>
                    <div class="venue">{{extractVenue(model.title)}}</div>
                </gd-show>
            </template>
        </core-list>
    </template>
    
    <script>
        Polymer("gd-list", {
            params: {
                "q": "collection:(GratefulDead AND etree ) AND -collection:stream_only",
                "fl[]": "identifier,date,description,title",
                "sort[]": "date asc",
                "rows": "10",
                "page": "0",
                "output": "json",
                "callback": "callback"
            },
            shows: {},

            //Functions
            showClickResponse: function (event, data, element) {
                //alert(element.identifier); //works!
            },
            getAlbumArt: function () {
                var rand = Math.round(Math.random() * 400) + 100;
                return "http://lorempixel.com/" + rand + "/" + rand + "/";
            },
            extractBand: function (title) {
                var band = title;
                if (band) {
                    if (band.indexOf(" Live ") >= 0) band = band.split(" Live ")[0];
                }
                return band;
            },
            extractDate: function (date) {
                var formatted = date;
                if (formatted) {
                    if (formatted.indexOf("T") >= 0) formatted = formatted.split("T")[0];
                }
                return formatted;
            },
            extractVenue: function (title) {
                var venue = title;
                if (venue) {
                    if (venue.indexOf(" at ") >= 0) venue = venue.split(" at ")[1];
                    if (venue.indexOf(" on ") >= 0) venue = venue.split(" on ")[0];
                }
                return venue;
            },
            
            ready: function () {
                this.$.ajax.go();
            }
        });
    </script>
</polymer-element>
