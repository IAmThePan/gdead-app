<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/core-ajax/core-ajax.html">
<link rel="import" href="bower_components/core-list/core-list.html">

<link rel="import" href="gd-show.html">

<polymer-element name="gd-list" attributes="">
    <template>
        <style>
            core-list {
                height: 100%;
            }
            gd-show {
                height: 215px;
            }
        </style>
        
        <core-ajax id="ajax"
                   url="https://archive.org/advancedsearch.php"
                   params="{{params}}"
                   handleAs="json"
                   response="{{shows}}">
        </core-ajax>
        
        <core-list id="list" data="{{shows.response.docs}}">
            <template>
                <gd-show identifier="{{model.identifier}}" albumart="{{getAlbumArt()}}" 
                         on-show-click="{{showClickResponse}}">
                    <div class="band">{{extractBand(model.title)}}</div>
                    <div class="date">{{extractDate(model.date)}}</div>
                    <div class="venue">{{extractVenue(model.title)}}</div>
                </gd-show>
            </template>
        </core-list>
    </template>
    
    <script>
        Polymer("gd-list", {
            params: {
                "q": "collection:(GratefulDead AND etree ) AND -collection:stream_only",
                "fl[]": "identifier,date,description,title",
                "sort[]": "date asc",
                "rows": "10",
                "page": "0",
                "output": "json",
            },
            shows: {},
            shows: {"responseHeader":{"status":0,"QTime":8,"params":{"qin":"collection:(GratefulDead AND etree ) AND -collection:stream_only","fl":"identifier,date,description,title","sort":"date asc","start":"0","q":"collection:(GratefulDead AND etree ) AND -collection:stream_only","wt":"json","rows":"10"}},"response":{"numFound":5244,"start":0,"docs":[{"date":"1966-10-31T00:00:00Z","title":"Grateful Dead Live at KFRC studio on 1966-11-00","description":"Set 1 Interview","identifier":"gd1966-11-00.FM.interview.ordon.sorochty.125586.flac16"},{"title":"Grateful Dead Live at Avalon Ballroom on 1967-01-27","description":"01 Viola Lee Blues 02 Morning Dew 03 Cold Rain And Snow 04 New Potato Caboose 05 Alligator > 06 Caution (Do Not Stop on Tracks) 07 Good Morning Little School Girl","date":"1967-01-27T00:00:00Z","identifier":"gd1967-01-27.sbd.8762.shnf"},{"description":"Morning Dew, New Potato Caboose, Viola Lee Blues, Cold Rain & Snow, Alligator-> Caution (Do Not Stop on Tracks), Good Morning Little School Girl","date":"1967-01-27T00:00:00Z","title":"Grateful Dead Live at Avalon Ballroom on 1967-01-27","identifier":"gd67-01-27.aud.hanno.16744.sbeok.shnf"},{"date":"1967-07-23T00:00:00Z","title":"Grateful Dead Live at Straight Theater on 1967-07-23","description":"Set 1 Jam*, *W/ Neil Cassidy, the jam may have been from another Straight Theater Show Straight Theater Opening 3rd Night - Other artist(s): The Phoenix; The Wildflower; Big Brother & The Holding Co.","identifier":"gd1967-07-23.aud.sorochty.125462.flac16"},{"title":"Grateful Dead Live at Dance Hall on 1967-09-03","description":"1. Dancin' In The Streets :10:27 2. It Hurts Me Too :04:00 3. Cold Rain & Snow :03:13 4. Good Morning Little Schoolgirl \\ :10:34 5. \\ Viola Lee Blues \\ :22:49 !!!!!!!!!!!!!!!!!!! 6. Big Boss Man :04:15 introduced as \"an old song\" 7. Alligator :14:35","date":"1967-09-03T00:00:00Z","identifier":"gd1967-09-03.sbd.miller.43.sbeok.shnf"},{"title":"Grateful Dead Live at Hollywood Bowl on 1967-09-15","description":"Viola Lee Blues, Cold Rain & Snow, Beat It On Down The Line, Good Morning Little School Girl, Morning Dew, Alligator-> Caution (Do Not Stop on Tracks)","date":"1967-09-15T00:00:00Z","identifier":"gd67-09-15.aud.vernon.9192.sbeok.shnf"},{"description":"Viola Lee Blues, Smokestack Lightning, Turn On Your Love Light, It Hurts Me Too","date":"1968-03-03T00:00:00Z","title":"Grateful Dead Live at Haight Street on 1968-03-03","identifier":"gd68-03-03.aud.jools.19904.sbeok.shnf"},{"title":"Grateful Dead Live at Haight Street on 1968-03-03","description":"Viola Lee Blues Smokestack Lightnin' Turn On Your Lovelight \"Mary is looking for Shirley...\" It Hurts Me Too","date":"1968-03-03T00:00:00Z","identifier":"gd1968-03-03.aud.finney.5809.sbeok.shnf"},{"description":"Viola Lee Blues, Smokestack Lightning, Turn On Your Love Light, It Hurts Me Too","date":"1968-03-03T00:00:00Z","title":"Grateful Dead Live at Haight Street on 1968-03-03","identifier":"gd68-03-03.aud.vernon.9374.sbeok.shnf"},{"title":"Grateful Dead Live at Carousel Ballroom on 1968-03-29","description":"Good Morning Little Schoolgirl > Death Don't Have No Mercy, Sittin' On Top Of The World, Dark Star","date":"1968-03-29T00:00:00Z","identifier":"gd68-03-29.aud.cotsman.6029.sbeok.shnf"}]}},

            //Functions
            showClickResponse: function (event, data, element) {
                //alert(element.identifier); //works!
            },
            getAlbumArt: function () {
                var rand = Math.round(Math.random() * 400) + 100;
                return "http://lorempixel.com/" + rand + "/" + rand + "/";
            },
            extractBand: function (title) {
                var band = title;
                if (band) {
                    if (band.indexOf(" Live ") >= 0) band = band.split(" Live ")[0];
                }
                return band;
            },
            extractDate: function (date) {
                var formatted = date;
                if (formatted) {
                    if (formatted.indexOf("T") >= 0) formatted = formatted.split("T")[0];
                }
                return formatted;
            },
            extractVenue: function (title) {
                var venue = title;
                if (venue) {
                    if (venue.indexOf(" at ") >= 0) venue = venue.split(" at ")[1];
                    if (venue.indexOf(" on ") >= 0) venue = venue.split(" on ")[0];
                }
                return venue;
            },
            
            ready: function () {
                //this.$.ajax.go();
            }
        });
    </script>
</polymer-element>
