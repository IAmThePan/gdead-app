<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../bower_components/core-list/core-list.html">

<link rel="import" href="gd-show.html">

<polymer-element name="gd-list" attributes="">
    <template>
        <style>
            core-list {
                height: 100%;
            }
            gd-show {
                height: 215px;
            }
        </style>
        
        <core-ajax id="ajax"
                   url="https://archive.org/advancedsearch.php"
                   params="{{params}}"
                   handleAs="json"
                   response="{{shows}}">
        </core-ajax>
        
        <core-list id="list" data="{{shows.response.docs}}">
            <template>
                <gd-show identifier="{{model.identifier}}" albumart="{{getAlbumArt(model.title)}}" 
                         on-show-click="{{showClickResponse}}">
                    <div class="band">{{extractBand(model.title)}}</div>
                    <div class="date">{{extractDate(model.date)}}</div>
                    <div class="venue">{{extractVenue(model.title)}}</div>
                </gd-show>
            </template>
        </core-list>
    </template>
    
    <script>
        function callbackList (data) {
            console.log("List jsonP", data);
            document.querySelector("#app").$.list.shows = data;
        }
        
        function callbackArt (data) {
            console.log("Art jsonP", data.responseData.results[0].url);
        
        }
        
        Polymer("gd-list", {
            params: {
                "q": "collection:(GratefulDead AND etree ) AND -collection:stream_only",
                "fl[]": "identifier,date,description,title",
                "sort[]": "date asc",
                "rows": "10",
                "page": "0",
                "output": "json",
            },
            shows: {},

            //Functions
            showClickResponse: function (event, data, element) {
                //alert(element.identifier); //works!
            },
            getAlbumArt: function (title) {
                var url = 'https://ajax.googleapis.com/ajax/services/search/images?v=1.0&q=' + title + '?&callback=callbackArt'
                
                var script = document.createElement('script');
                script.src = url;
                document.getElementsByTagName('head')[0].appendChild(script);
            },
            extractBand: function (title) {
                var band = title;
                if (band) {
                    if (band.indexOf(" Live ") >= 0) band = band.split(" Live ")[0];
                }
                return band;
            },
            extractDate: function (date) {
                var formatted = date;
                if (formatted) {
                    if (formatted.indexOf("T") >= 0) formatted = formatted.split("T")[0];
                }
                return formatted;
            },
            extractVenue: function (title) {
                var venue = title;
                if (venue) {
                    if (venue.indexOf(" at ") >= 0) venue = venue.split(" at ")[1];
                    if (venue.indexOf(" on ") >= 0) venue = venue.split(" on ")[0];
                }
                return venue;
            },
            
            ready: function () {
                var url = 'https://archive.org/advancedsearch.php?q=collection%3A(GratefulDead%20AND%20etree%20)%20AND%20-collection%3Astream_only&fl%5B%5D=identifier%2Cdate%2Cdescription%2Ctitle&sort%5B%5D=date%20asc&rows=100&page=0&output=json&callback=callbackList';
                
                var script = document.createElement('script');
                script.src = url;
                document.getElementsByTagName('head')[0].appendChild(script);
                //this.$.ajax.go();
            }
        });
    </script>
</polymer-element>
