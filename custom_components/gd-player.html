<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-image/core-image.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">

<link rel="import" href="player-controls.html">
<link rel="import" href="progress-slider.html">

<!--
ToDo:
    Add scrolling time somewhere
    Implement Previous and Next buttons
    Create a Playlist element to keep track of played/upcomming songs 
        - Data only for next/previous buttons
        - Then also UI to navigate songs
-->
<polymer-element name="gd-player" attributes="albumArt songTitle songAlt">
    <template>
        <style>
            #player {
                display: flex;
                position: absolute;
                width: 100%;
                height: 80px;
                bottom: 0px;
                background-color: white;
            }
            
            #albumArt {
                width: 80px;
                height: 100%;
            }
            
            #middle {
                padding: 10px;
            }
            #text {
                color: black;
                height: 75px;
                display: flex;
                flex-direction: column;
                justify-content: space-around;
                font-size: 1.2em;
                white-space: nowrap;
                overflow: hidden;
            }
            #songTitle {
                font-weight: 600;
            }
            #playerControls {
                color: black;
                height: 80px;
            }
            
            #progressSlider {
                color: black;
                display: none;
            }
            #progressSlider /deep/ paper-slider::shadow #sliderBar::shadow #activeProgress {
                background-color: teal;
            }
            #progressSlider /deep/ paper-slider::shadow #sliderKnobInner {
                background-color: teal;
            }
            #progressSlider /deep/ paper-slider::shadow #sliderKnob > #sliderKnobInner::after {
                <!--color: #0f9d58-->
            }
            
            #progressStatic {
                display: block;
                position: absolute;
                bottom: 0;
                width: 100%;
            }
            paper-progress#progressStatic::shadow #activeProgress {
                background-color: teal;
            }
            paper-progress#progressStatic::shadow #progressContainer {
                background-color: transparent;
            }
            
            @media (min-width: 600px) {
                #text {
                    height: 30px;
                    padding-top: 6px;
                    flex-direction: row;
                    justify-content: space-around;
                }
                #progressSlider {
                    display: block;
                }
                #progressStatic {
                    display: none;
                }
            }
        </style>
        
        <div id="player">
            <core-image id="albumArt" sizing="cover" preload fade 
                        on-click="{{albumArtClick}}"
                        placeholder="images/gd-logo.svg"
                        src="{{albumArt}}">
            </core-image>
            <div id="middle" flex layout vertical justified>
                <div id="text">
                    <div id="songTitle">{{songTitle}}</div>
                    <div id="songAlt">{{songAlt}}</div>
                </div>
                <progress-slider id="progressSlider" max="{{songLength}}" value="{{songProgress}}"
                                 on-seek="{{seek}}">
                </progress-slider>
            </div>
            
            
            <player-controls id="playerControls" playing="false"
                             on-play="{{controlsPlay}}" on-pause="{{controlsPause}}"
                             on-previous="{{controlsPrevious}}" on-next="{{controlsNext}}">
            </player-controls>
        </div>
        <paper-progress id="progressStatic" 
                        value="{{songProgress / (songLength + 0.0001) * 100}}">
        </paper-progress>
        
        <audio id="audio" on-timeupdate="{{timeUpdate}}" on-ended="{{trackEnded}}"
               src="https://archive.org/download/gd1984-06-21.beyerm201.holbrook.burke.91024.sbeok.flac16/gd1984-06-21s2t02.mp3">
        </audio>
    </template>
    
    <script>
        Polymer("gd-player", {
            songTitle: "Song Title",
            songAlt: "Album Title or Location",
            albumArt: "images/gd-logo.svg",
            
            songLength: 194,
            songProgress: 147,
            
            //Functions
            play: function () {
                this.$.audio.play();
                this.$.playerControls.playing = true;
                this.songProgress = 0;
                console.log("gd-player: play");
            },
            timeUpdate: function () {
                if (!this.$.progressSlider.$.slider.dragging) { 
                    this.songLength = Math.floor(this.$.audio.seekable.end(0));
                    this.songProgress = Math.floor(this.$.audio.currentTime);
                    //console.log("gd-player: timeUpdate");
                }
                else {
                    console.log("gd-player: seeking", this.$.progressSlider.$.slider.immediateValue);
                }
            },
            trackEnded: function () {
                this.$.playerControls.playing = false;
                console.log("gd-player: trackEnded");
            },
            seek: function (event) {
                this.$.audio.currentTime = event.detail;
                console.log("gd-player: seek", event.detail);
            },
            albumArtClick: function () {
                console.log("gd-player: albumArtClick");
            },
            controlsPlay: function () {
                this.$.audio.play();
                this.$.playerControls.playing = true;
                console.log("gd-player: controlsPlay");
            },
            controlsPause: function () {
                this.$.audio.pause();
                this.$.playerControls.playing = false;
                console.log("gd-player: controlsPause");
            },
            controlsPrevious: function () {
                console.log("gd-player: controlsPrevious");
            },
            controlsNext: function () {
                console.log("gd-player: controlsNext");
            },
            
            
        });
    </script>
</polymer-element>