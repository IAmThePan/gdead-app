<link rel="import" href="../bower_components/polymer/polymer.html">
<script src="md5.js"></script>

<polymer-element name="ajax-jsonp" attributes="url identifier fn params auto">
    <template>
        <style>
        </style>
        
    </template>
    
    <script>
        Polymer("ajax-jsonp", {
            //Attribute Defaults
            url: "",
            identifier: "",
            fn: function () {
                console.log("Ajax JSONP default");
            },
            params: {},
            auto: false,
            
            //Functions
            ready: function () {
                window.callbackJsonP = window.callbackJsonP || {};
                if (this.auto) this.go();
            },
            go: function () {
                var key     = "key" + md5(this.identifier + Math.random()).toString(),
                    script  = document.createElement("script"),
                    params  = this.params;
                    fn      = this.fn;
                
                window.callbackJsonP[key] = function () {
                    var n, fnName;
                    for (n in this) fnName = n;
                    
                    fn(params);
                    
                    delete window.callbackJsonP[fnName];
                    document.getElementById(fnName).remove();
                }
                
                script.id = key;
                script.src = this.url + "&callback=callbackJsonP." + key;
                document.getElementsByTagName("head")[0].appendChild(script);
            },
        });
    </script>
</polymer-element>
